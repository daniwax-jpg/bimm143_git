---
title: "Class14"
format: pdf
toc: true
---

##Background

Here we work through a complete RNASeq analysis project. The input data comes from a 


##Data Import

Reading the `counts` and `metadata` CSV files

```{r, message=FALSE}
library(DESeq2)
metafile <- read.csv("GSE37704_metadata.csv", row.names = 1)
countfile <- "GSE37704_featurecounts.csv"
```





```{r}
# Import countdata
countData = read.csv(countfile, row.names=1)
```


```{r}
countData <- as.matrix(countData[,-1])
head(countData)
```

```{r}
nonzero_counts <- countData[rowSums(countData)>0,]
head(nonzero_counts)
```




Load the package

##DESeq analysis
```{r, message=FALSE}
library(DESeq2)
```



Setup DESeq object

```{r}
dds <- DESeqDataSetFromMatrix(countData = nonzero_counts,
                              colData = metafile,
                              design = ~condition)
```

run DESeq

```{r}
dds <- DESeq(dds)
```



Get results


```{r}
res <- results(dds)
```


##Data Visualization 

Volcano plot


```{r}
library(ggplot2)

ggplot(res) +
  aes(log2FoldChange, -log(padj)) +
  geom_point()+
geom_vline(xintercept=c(-2,2),col="red")+
  geom_hline(yintercept=-log(0.05),col="red")
```


##Add annotation

Add gene symbols and entrez IDs

```{r}
library(AnnotationDbi)
library(org.Hs.eg.db)
```

```{r}
res$symbol <- mapIds(x=org.Hs.eg.db,
       keys=row.names(res),
       keytype="ENSEMBL",
       column="SYMBOL")

res$entrez <- mapIds(x=org.Hs.eg.db,
       keys=row.names(res),
       keytype="ENSEMBL",
       column="ENTREZID")
```

##Pathway analysis

Run Gage analysis

```{r}
library(gage)
library(gageData)
library(pathview)
```
We need a named vector of fold-change values as input for gage


```{r}
foldchanges = res$log2FoldChange
names(foldchanges) = res$entrez
head(foldchanges)
data(kegg.sets.hs)
```

```{r}
# Get the results
keggres = gage(foldchanges, gsets=kegg.sets.hs)
```

```{r}
head(keggres$less, 5)
```

```{r}
pathview(pathway.id= "hsa04110", gene.data=foldchanges)
```

![](hsa04110.pathview.png)


### GO terms

Same anaysis, but using GO genesets rather than KEGG

```{r}
data(go.sets.hs)
data(go.subs.hs)

# Focus on Biological Process subset of GO
gobpsets = go.sets.hs[go.subs.hs$BP]

gobpres = gage(foldchanges, gsets=gobpsets, same.dir=TRUE)

lapply(gobpres, head)
```
###Reactome

Lots of folks like the reactome web interface. You can also run this as an R function, but let's look at the website first. < https://reactome.org/ >

The website wants a text file with one gene symbol per line of the genes you want to map to pathways. 

```{r}
sig_genes <- res[res$padj <= 0.05 & !is.na(res$padj), "symbol"]
head(sig_genes)
#res$symbol
```

and write out to a file:

```{r}
write.table(sig_genes, file="significant_genes.txt", row.names=FALSE, col.names=FALSE, quote=FALSE)
```


##Save our results

```{r}
write.csv(res, file="myresults.csv")
```





